<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verwalco</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #29292d;
            color: #ebebeb;
        }
        .container { 
            margin-top: 30px; 
        }
        .card {
            background-color: #525258;
            color: #ffffff;
        }
        .form-group { margin-bottom: 15px; }
        .edit-mode input { margin-bottom: 5px; }
        .konto-group {
            margin-top: 20px;
            margin-bottom: 10px;
            background-color: #525258;
            padding: 10px;
            border-radius: 5px;
        }
        .konto-header {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }
        .table {
            width: 100%;
            table-layout: fixed;
        }
        .table th, .table td {
            padding: 8px;
            vertical-align: middle;
        }
        .col-bezeichnung { width: 35%; }
        .col-betrag { width: 20%; }
        .col-zahlungstag { width: 15%; }
        .col-bezahlt { width: 10%; }
        .col-aktionen { 
            width: 20%; 
            text-align: right;
        }
        .col-aktionen button {
            margin-right: 5px;
        }
        .col-aktionen button:last-child {
            margin-right: 0;
        }
        .form-control {
            width: 100%;
        }
        .btn-group-sm > .btn, .btn-sm {
            padding: 0.25rem 0.5rem;
        }
        .draggable {
            cursor: move;
            user-select: none;
        }
        .dragging {
            opacity: 0.5;
            background-color: #e9ecef;
        }
        .drag-handle {
            cursor: move;
            padding: 5px;
            margin-right: 5px;
            color: #6c757d;
        }
        .drag-handle:hover {
            color: #495057;
        }
    </style>    
</head>
<body>
    <div class="container">
        <h1>Verwalco</h1>
        <p>Überblick über die laufenden Kosten</p>
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Neue Kosten hinzufügen</h5>
                <form id="kostenForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="bezeichnung">Bezeichnung</label>
                                <input type="text" class="form-control" id="bezeichnung" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="betrag">Betrag (€)</label>
                                <input type="number" step="0.01" class="form-control" id="betrag" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="zahlungstag">Zahlungstag</label>
                                <select class="form-control" id="zahlungstag" required>
                                    <option value="">Wählen...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="konto">Konto</label>
                                <input type="text" class="form-control" id="konto" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary mt-4">Hinzufügen</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <div id="kostenListe">
                <!-- Hier werden die Kontogruppen dynamisch eingefügt -->
            </div>
        </div>

        <div class="card mt-3" style="margin-bottom: 50px;">
            <div class="card-body" style="text-align: right;">
                <h5 class="card-title">Gesamtsumme (unbezahlte Kosten)</h5>
                <h3 id="gesamtsumme">0,00 €</h3>
            </div>
        </div>
    </div>

    <script>
        // Zahlungstage-Dropdown befüllen
        const zahlungstagSelect = document.getElementById('zahlungstag');
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            zahlungstagSelect.appendChild(option);
        }

        // Form-Handler initialisieren
        document.getElementById('kostenForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                bezeichnung: document.getElementById('bezeichnung').value,
                betrag: document.getElementById('betrag').value,
                zahlungstag: document.getElementById('zahlungstag').value,
                konto: document.getElementById('konto').value
            };

            try {
                const response = await fetch('/api/kosten', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.success) {
                    // Form zurücksetzen
                    document.getElementById('kostenForm').reset();
                    // Kosten neu laden
                    loadKosten();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Kosten nach Konten gruppieren
        function groupByKonto(kosten) {
            const groups = {};
            kosten.forEach(k => {
                if (!groups[k.konto]) {
                    groups[k.konto] = [];
                }
                groups[k.konto].push(k);
            });
            return groups;
        }

        // Kosten laden
        async function loadKosten() {
            const response = await fetch('/api/kosten');
            const kosten = await response.json();
            displayKosten(kosten);
        }

        // Kosten anzeigen
        function displayKosten(kostenListe) {
            const kostenListeElement = document.getElementById('kostenListe');
            const kontoGruppen = groupByKonto(kostenListe);
            
            kostenListeElement.innerHTML = '';
            
            // Gesamtsumme berechnen
            let gesamtsumme = 0;
            kostenListe.forEach(k => {
                if (!k.bezahlt) {
                    gesamtsumme += k.betrag;
                }
            });
            document.getElementById('gesamtsumme').textContent = gesamtsumme.toFixed(2) + ' €';
            
            Object.keys(kontoGruppen).sort().forEach(konto => {
                const kontoGruppe = document.createElement('div');
                kontoGruppe.className = 'konto-group';
                kontoGruppe.dataset.konto = konto;
                
                const kontoHeader = document.createElement('div');
                kontoHeader.className = 'konto-header';
                kontoHeader.textContent = konto;
                
                const table = document.createElement('table');
                table.className = 'table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th style="width: 30px"></th>
                            <th class="col-bezeichnung">Bezeichnung</th>
                            <th class="col-betrag">Betrag</th>
                            <th class="col-zahlungstag">Zahlungstag</th>
                            <th class="col-bezahlt">Bezahlt</th>
                            <th class="col-aktionen">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                
                kontoGruppen[konto].forEach(k => {
                    const tr = document.createElement('tr');
                    tr.draggable = true;
                    tr.dataset.id = k.id;
                    tr.dataset.konto = konto;
                    tr.className = 'draggable';
                    
                    tr.addEventListener('dragstart', handleDragStart);
                    tr.addEventListener('dragend', handleDragEnd);
                    tr.addEventListener('dragover', handleDragOver);
                    tr.addEventListener('drop', handleDrop);
                    
                    tr.innerHTML = `
                        <td>
                            <span class="drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </span>
                        </td>
                        <td class="col-bezeichnung">${k.bezeichnung}</td>
                        <td class="col-betrag">${k.betrag.toFixed(2)} €</td>
                        <td class="col-zahlungstag">${k.zahlungstag}</td>
                        <td class="col-bezahlt">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" 
                                    ${k.bezahlt ? 'checked' : ''} 
                                    onchange="updateBezahlt(${k.id}, this.checked)">
                            </div>
                        </td>
                        <td class="col-aktionen">
                            <button class="btn btn-sm btn-primary" onclick="startEdit(${k.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteKosten(${k.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                kontoGruppe.appendChild(kontoHeader);
                kontoGruppe.appendChild(table);
                kostenListeElement.appendChild(kontoGruppe);
            });
        }

        let draggedItem = null;
        let draggedKonto = null;

        function handleDragStart(e) {
            draggedItem = this;
            draggedKonto = this.dataset.konto;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', ''); // Required for Firefox
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            draggedKonto = null;
            
            // Remove all drag-over classes
            document.querySelectorAll('.draggable').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const tr = e.target.closest('tr');
            if (!tr || tr === draggedItem || tr.dataset.konto !== draggedKonto) return;
            
            const tbody = tr.parentNode;
            const rect = tr.getBoundingClientRect();
            const middle = rect.top + rect.height / 2;
            
            if (e.clientY < middle) {
                tbody.insertBefore(draggedItem, tr);
            } else {
                tbody.insertBefore(draggedItem, tr.nextSibling);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedItem) {
                updatePositions();
            }
        }

        function updatePositions() {
            const tables = document.querySelectorAll('.table tbody');
            const newPositions = [];
            let position = 0;
            
            tables.forEach(tbody => {
                const konto = tbody.closest('.konto-group').dataset.konto;
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    if (row.dataset.konto === konto) {
                        newPositions.push({
                            id: parseInt(row.dataset.id),
                            position: position++
                        });
                    }
                });
            });

            fetch('/api/kosten/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newPositions)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadKosten();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Bearbeitung starten
        function startEdit(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const bezeichnung = row.querySelector('.col-bezeichnung').textContent;
            const betrag = parseFloat(row.querySelector('.col-betrag').textContent);
            const zahlungstag = row.querySelector('.col-zahlungstag').textContent;
            const konto = row.closest('.konto-group').querySelector('.konto-header').textContent.replace('Konto: ', '');

            row.innerHTML = `
                <td>
                    <span class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </span>
                </td>
                <td class="col-bezeichnung">
                    <input type="text" class="form-control" value="${bezeichnung}" id="edit-bezeichnung-${id}">
                </td>
                <td class="col-betrag">
                    <input type="number" step="0.01" class="form-control" value="${betrag}" id="edit-betrag-${id}">
                </td>
                <td class="col-zahlungstag">
                    <select class="form-control" id="edit-zahlungstag-${id}">
                        ${Array.from({length: 31}, (_, i) => i + 1)
                            .map(day => `<option value="${day}" ${day == zahlungstag ? 'selected' : ''}>${day}</option>`)
                            .join('')}
                    </select>
                </td>
                <td class="col-bezahlt">
                    <input type="text" class="form-control" value="${konto}" id="edit-konto-${id}">
                </td>
                <td class="col-aktionen">
                    <button class="btn btn-success btn-sm me-2" onclick="saveEdit(${id})">Speichern</button>
                    <button class="btn btn-secondary btn-sm" onclick="loadKosten()">Abbrechen</button>
                </td>
            `;
        }

        // Bearbeitung speichern
        async function saveEdit(id) {
            const bezeichnung = document.getElementById(`edit-bezeichnung-${id}`).value;
            const betrag = document.getElementById(`edit-betrag-${id}`).value;
            const zahlungstag = document.getElementById(`edit-zahlungstag-${id}`).value;
            const konto = document.getElementById(`edit-konto-${id}`).value;

            await fetch(`/api/kosten/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bezeichnung,
                    betrag: parseFloat(betrag),
                    zahlungstag: parseInt(zahlungstag),
                    konto
                })
            });

            loadKosten();
        }

        // Bezahlt-Status aktualisieren
        async function updateBezahlt(id, bezahlt) {
            await fetch(`/api/kosten/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bezahlt })
            });
            loadKosten();
        }

        // Kosten löschen
        async function deleteKosten(id) {
            if (confirm('Möchten Sie diesen Eintrag wirklich löschen?')) {
                await fetch(`/api/kosten/${id}`, {
                    method: 'DELETE'
                });
                loadKosten();
            }
        }

        // Initial laden
        loadKosten();
    </script>
</body>
</html>
